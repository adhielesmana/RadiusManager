version: '3.8'

services:
  # PostgreSQL Database - Shared by ISP Manager and FreeRADIUS
  postgres:
    image: postgres:15-alpine
    container_name: isp-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: ispmanager
      POSTGRES_USER: ispuser
      POSTGRES_PASSWORD: ${DB_PASSWORD:-isppass123}
    ports:
      # Use host port 5433 to avoid conflicts with existing PostgreSQL on 5432
      - "${POSTGRES_HOST_PORT:-5433}:5432"
    volumes:
      - isp-postgres-data:/var/lib/postgresql/data
      - ./docker/postgres-init:/docker-entrypoint-initdb.d
    networks:
      - isp-internal-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ispuser -d ispmanager"]
      interval: 10s
      timeout: 5s
      retries: 5
    # Resource limits to prevent interference with other containers
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 256M

  # FreeRADIUS Server with PostgreSQL Backend
  freeradius:
    image: freeradius/freeradius-server:latest
    container_name: isp-freeradius
    restart: unless-stopped
    ports:
      - "${RADIUS_AUTH_PORT:-1812}:1812/udp"  # Authentication
      - "${RADIUS_ACCT_PORT:-1813}:1813/udp"  # Accounting
      - "${RADIUS_STATUS_PORT:-18120}:18120"   # Status server (optional)
    environment:
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_USER=ispuser
      - DB_PASS=${DB_PASSWORD:-isppass123}
      - DB_NAME=ispmanager
      - RADIUS_SECRET=${RADIUS_SECRET:-testing123}
    volumes:
      - ./docker/freeradius/clients.conf:/etc/raddb/clients.conf:ro
      - ./docker/freeradius/sql:/etc/raddb/mods-available/sql:ro
      - ./docker/freeradius/default:/etc/raddb/sites-available/default:ro
      - ./docker/freeradius/inner-tunnel:/etc/raddb/sites-available/inner-tunnel:ro
      - ./docker/freeradius/docker-entrypoint.sh:/docker-entrypoint.sh:ro
    entrypoint: ["/bin/sh", "/docker-entrypoint.sh"]
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - isp-internal-network
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M

  # ISP Manager Application (Node.js + React)
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: isp-manager-app
    restart: unless-stopped
    ports:
      # Auto-assign available port or use custom port from env
      - "${APP_HOST_PORT:-5000}:5000"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - DATABASE_URL=postgresql://ispuser:${DB_PASSWORD:-isppass123}@postgres:5432/ispmanager
      - PGHOST=postgres
      - PGPORT=5432
      - PGUSER=ispuser
      - PGPASSWORD=${DB_PASSWORD:-isppass123}
      - PGDATABASE=ispmanager
      - SESSION_SECRET=${SESSION_SECRET:-change-this-in-production}
      - RADIUS_HOST=freeradius
      - RADIUS_SECRET=${RADIUS_SECRET:-testing123}
    volumes:
      # Mount for development (comment out for production)
      - ./client:/app/client
      - ./server:/app/server
      - ./shared:/app/shared
      - /app/node_modules
    depends_on:
      postgres:
        condition: service_healthy
      freeradius:
        condition: service_started
    networks:
      - isp-internal-network
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

volumes:
  # Namespaced volume names to avoid conflicts
  isp-postgres-data:
    driver: local
    name: isp-manager-postgres-data

networks:
  # Isolated network with custom subnet to avoid conflicts
  isp-internal-network:
    driver: bridge
    name: isp-manager-network
    ipam:
      driver: default
      config:
        # Use a unique subnet that won't conflict with other Docker networks
        # Default Docker uses 172.17.0.0/16, so we use 172.25.0.0/16
        - subnet: 172.25.0.0/16
          gateway: 172.25.0.1
