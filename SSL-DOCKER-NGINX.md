# SSL Certificate for Docker Nginx Setup

## Your Situation
- ‚úÖ ISP Manager runs in Docker (port 5000)
- ‚úÖ Nginx runs in **another Docker container** (ports 80/443)
- ‚ùå `certbot --nginx` doesn't work (plugin can't access Dockerized Nginx)

---

## Solution: Use Certbot Webroot or Standalone Mode

Since your Nginx is in Docker, the nginx plugin won't work. Use one of these methods instead:

---

## üéØ Method 1: Webroot Mode (Recommended - No Downtime)

This method works **without stopping Nginx**.

### Step 1: Create Webroot Directory

```bash
mkdir -p /var/www/html/.well-known/acme-challenge
chmod 755 /var/www/html/.well-known/acme-challenge
```

### Step 2: Configure Your Docker Nginx

Your Nginx container needs to serve the `.well-known` directory. Add this to your Nginx config:

```nginx
server {
    listen 80;
    server_name isp.maxnetplus.id;

    # Let's Encrypt ACME challenge
    location /.well-known/acme-challenge/ {
        root /var/www/html;
        allow all;
    }

    # Redirect other traffic to HTTPS
    location / {
        return 301 https://$server_name$request_uri;
    }
}
```

**Important:** Mount `/var/www/html` in your Nginx Docker container:

```yaml
# In your docker-compose.yml for Nginx:
services:
  nginx:
    image: nginx:latest
    volumes:
      - /var/www/html:/var/www/html:ro
      - /etc/letsencrypt:/etc/letsencrypt:ro
      - ./nginx.conf:/etc/nginx/conf.d/default.conf
    ports:
      - "80:80"
      - "443:443"
```

### Step 3: Get Certificate

```bash
certbot certonly --webroot \
  -w /var/www/html \
  -d isp.maxnetplus.id \
  -m adhielesmana@gmail.com \
  --agree-tos
```

### Step 4: Reload Nginx Container

```bash
docker restart <your-nginx-container-name>
# or
docker compose -f <your-nginx-compose-file> restart nginx
```

---

## üéØ Method 2: Standalone Mode (Requires Downtime)

This method is simpler but requires temporarily stopping Nginx.

### Step 1: Stop Nginx Container

```bash
docker stop <your-nginx-container-name>
# or
docker compose -f <your-nginx-compose-file> stop nginx
```

### Step 2: Get Certificate

```bash
certbot certonly --standalone \
  -d isp.maxnetplus.id \
  -m adhielesmana@gmail.com \
  --agree-tos
```

### Step 3: Start Nginx Container

```bash
docker start <your-nginx-container-name>
# or
docker compose -f <your-nginx-compose-file> start nginx
```

---

## üìã After Getting Certificate

Once you have the certificate, add the ISP Manager config to your Nginx:

### Step 1: Use Generated Config

The config file was already generated by `./deploy.sh` at:
```
/etc/nginx/sites-available/isp-manager
```

Or generate it again:
```bash
./generate-nginx-config.sh
```

### Step 2: Copy to Your Nginx Container

Since your Nginx is in Docker, you need to make this config available to the container.

**Option A: Copy into container**
```bash
docker cp /etc/nginx/sites-available/isp-manager <nginx-container>:/etc/nginx/conf.d/isp-manager.conf
docker restart <nginx-container>
```

**Option B: Volume mount (better for persistence)**

Update your Nginx docker-compose to mount the config:

```yaml
services:
  nginx:
    image: nginx:latest
    volumes:
      - /etc/nginx/sites-available:/etc/nginx/conf.d:ro
      - /etc/letsencrypt:/etc/letsencrypt:ro
      - /var/www/html:/var/www/html:ro
    ports:
      - "80:80"
      - "443:443"
```

Then restart:
```bash
docker compose -f <your-nginx-compose> restart nginx
```

---

## üîÑ Certificate Renewal

Certbot automatically sets up a cron job for renewal. Test it:

```bash
# Dry run (test without actually renewing)
certbot renew --dry-run

# Force renewal (if needed)
certbot renew --force-renewal
```

After renewal, reload your Nginx container:
```bash
docker restart <nginx-container>
```

You can automate this with a cron job:
```bash
# Add to crontab
crontab -e

# Add this line (runs at 2am daily, reloads nginx if renewed)
0 2 * * * certbot renew --quiet --deploy-hook "docker restart <nginx-container-name>"
```

---

## ‚úÖ Complete Example for Your Setup

```bash
# 1. Create webroot directory
mkdir -p /var/www/html/.well-known/acme-challenge
chmod 755 /var/www/html/.well-known/acme-challenge

# 2. Make sure your Nginx container has access to:
#    - /var/www/html (for acme challenge)
#    - /etc/letsencrypt (for SSL certs)
#    Update your Nginx docker-compose.yml accordingly

# 3. Reload Nginx container to apply volume changes
docker compose -f <your-nginx-compose> restart nginx

# 4. Get SSL certificate
certbot certonly --webroot \
  -w /var/www/html \
  -d isp.maxnetplus.id \
  -m adhielesmana@gmail.com \
  --agree-tos

# 5. Copy ISP Manager config to Nginx container
docker cp /etc/nginx/sites-available/isp-manager \
  <nginx-container>:/etc/nginx/conf.d/isp-manager.conf

# 6. Test Nginx config
docker exec <nginx-container> nginx -t

# 7. Reload Nginx
docker restart <nginx-container>

# 8. Access your ISP Manager
# https://isp.maxnetplus.id
```

---

## üîç Troubleshooting

### Certificate Path Issues

Certificates are saved to:
```
/etc/letsencrypt/live/isp.maxnetplus.id/fullchain.pem
/etc/letsencrypt/live/isp.maxnetplus.id/privkey.pem
```

Make sure your Nginx container can access these:
```yaml
volumes:
  - /etc/letsencrypt:/etc/letsencrypt:ro
```

### Port 80 Already in Use

If standalone mode fails with "port already in use":
```bash
# Check what's using port 80
netstat -tlnp | grep :80

# Stop the service temporarily
docker stop <container-on-port-80>

# Run certbot
certbot certonly --standalone -d isp.maxnetplus.id

# Restart the service
docker start <container-on-port-80>
```

### Webroot Challenge Fails

If webroot mode fails with "Connection refused":
1. Check Nginx is serving the `.well-known` directory
2. Verify the volume mount is correct
3. Check firewall allows port 80 from the internet
4. Test access: `curl http://isp.maxnetplus.id/.well-known/acme-challenge/test.txt`

---

## üìä Summary

| Method | Downtime | Complexity | Recommended |
|--------|----------|------------|-------------|
| Webroot | ‚ùå None | Medium | ‚úÖ Yes (production) |
| Standalone | ‚úÖ ~30 sec | Low | For testing |

**For Production:** Use webroot mode with proper volume mounts

**For Quick Test:** Use standalone mode (stop nginx briefly)

---

**Last Updated:** November 11, 2025  
**Issue:** Certbot nginx plugin doesn't work with Dockerized Nginx  
**Solution:** Use webroot or standalone mode instead  
**Status:** ‚úÖ Updated all scripts with correct instructions
